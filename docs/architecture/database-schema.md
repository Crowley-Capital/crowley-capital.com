# Database Field Mapping - Articles Table

## Complete Schema Mapping

This document shows how AI-generated article fields map to the PostgreSQL database schema.

### Database Schema

```sql
CREATE TABLE articles (
    id SERIAL PRIMARY KEY,
    date_created TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP NULL,
    date_published TIMESTAMPTZ NULL,
    date_modified TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT NOT NULL,
    article TEXT NOT NULL,
    url VARCHAR(255) NOT NULL,
    meta_description TEXT NULL,
    topic VARCHAR(255) NULL,
    author VARCHAR(100) DEFAULT 'Jake Crowley' NOT NULL,
    publisher VARCHAR(100) DEFAULT 'Crowley Capital' NULL,
    status VARCHAR(50) DEFAULT 'draft' NULL,
    featured BOOLEAN DEFAULT false NULL
);
```

### Field Mapping

| Database Field | Type | Constraint | Source | Validation |
|---------------|------|------------|--------|------------|
| `id` | SERIAL | PRIMARY KEY | Auto-generated by DB | N/A |
| `date_created` | TIMESTAMPTZ | DEFAULT CURRENT_TIMESTAMP | Auto-set by DB | N/A |
| `date_published` | TIMESTAMPTZ | NULL | `new Date().toISOString()` if published, else `null` | Valid ISO timestamp |
| `date_modified` | TIMESTAMPTZ | DEFAULT CURRENT_TIMESTAMP | Auto-updated by DB trigger | N/A |
| `title` | VARCHAR(255) | NOT NULL | `generatedArticle.title` | Truncated to 255 chars |
| `description` | TEXT | NOT NULL | `generatedArticle.excerpt` | Must not be empty |
| `article` | TEXT | NOT NULL | `generatedArticle.content` | Must not be empty (HTML) |
| `url` | VARCHAR(255) | NOT NULL | `generatedArticle.slug` | Truncated to 255 chars, URL-safe |
| `meta_description` | TEXT | NULL | `generatedArticle.excerpt` | Same as description |
| `topic` | VARCHAR(255) | NULL | `generatedArticle.category` | Truncated to 255 chars |
| `author` | VARCHAR(100) | DEFAULT 'Jake Crowley', NOT NULL | `generatedArticle.author` | Truncated to 100 chars |
| `publisher` | VARCHAR(100) | DEFAULT 'Crowley Capital' | Hardcoded: `'Crowley Capital'` | Max 100 chars |
| `status` | VARCHAR(50) | DEFAULT 'draft' | `'draft'` or `'published'` | Valid values: draft, scheduled, published |
| `featured` | BOOLEAN | DEFAULT false | `isFeatured` toggle state | Boolean true/false |

## AI Service Validation

The `aiService.ts` file includes validation to ensure generated content fits database constraints:

```typescript
// Validate and truncate fields to match database constraints
const validatedTitle = title.substring(0, 255);      // varchar(255)
const validatedSlug = slug.substring(0, 255);        // varchar(255)
const validatedCategory = category.substring(0, 255); // varchar(255)
const validatedAuthor = AI_SETTINGS.DEFAULT_AUTHOR.substring(0, 100); // varchar(100)

// Ensure required fields are not empty
if (!validatedTitle || !excerpt || !content) {
  throw new Error('Generated article is missing required fields');
}
```

## Admin Panel Mapping

The `handleSaveArticle` function in `Admin.tsx` maps the generated article to the database schema:

```typescript
const articleData = {
  // Timestamps (auto-set by DB)
  date_published: status === 'published' ? new Date().toISOString() : null,
  
  // Required fields
  title: generatedArticle.title.substring(0, 255),
  description: generatedArticle.excerpt,
  article: generatedArticle.content,
  url: generatedArticle.slug.substring(0, 255),
  
  // Optional fields
  meta_description: generatedArticle.excerpt || null,
  topic: generatedArticle.category?.substring(0, 255) || null,
  
  // Fields with defaults
  author: generatedArticle.author.substring(0, 100),
  publisher: 'Crowley Capital',
  status: status,
  featured: isFeatured
};
```

## API Endpoint

**POST** `/api/articles`

### Request Body Example

```json
{
  "date_published": "2025-10-07T12:00:00.000Z",
  "title": "Mastering Fundraising: 7 Proven Strategies for Startup Success",
  "description": "Unlock your startup's potential with these 7 proven fundraising strategies...",
  "article": "<div class=\"answer-box\">...</div><h2>Key Takeaways</h2>...",
  "url": "mastering-fundraising-7-proven-strategies-for-startup-success",
  "meta_description": "Unlock your startup's potential with these 7 proven fundraising strategies...",
  "topic": "Fundraising",
  "author": "Jake Crowley",
  "publisher": "Crowley Capital",
  "status": "published",
  "featured": false
}
```

### Response Example

```json
{
  "id": 1,
  "date_created": "2025-10-07T12:00:00.000Z",
  "date_published": "2025-10-07T12:00:00.000Z",
  "date_modified": "2025-10-07T12:00:00.000Z",
  "title": "Mastering Fundraising: 7 Proven Strategies for Startup Success",
  "description": "Unlock your startup's potential...",
  "article": "<div class=\"answer-box\">...</div>...",
  "url": "mastering-fundraising-7-proven-strategies-for-startup-success",
  "meta_description": "Unlock your startup's potential...",
  "topic": "Fundraising",
  "author": "Jake Crowley",
  "publisher": "Crowley Capital",
  "status": "published",
  "featured": false
}
```

## Status Values

The `status` field accepts the following values (enforced by DB constraint):

- `draft` - Article is saved but not published
- `scheduled` - Article is scheduled for future publication
- `published` - Article is live and publicly visible

## Notes

1. **Auto-generated fields**: `id`, `date_created`, `date_modified` are handled by PostgreSQL
2. **Timestamps**: All dates are stored as `TIMESTAMPTZ` (timezone-aware)
3. **URL uniqueness**: The `url` field has a UNIQUE constraint in the database
4. **Validation**: Both frontend and backend validate field lengths before insertion
5. **Featured flag**: Controlled by toggle in Admin panel "Generate" tab
6. **Publisher**: Always set to "Crowley Capital" (hardcoded)
7. **Author**: Defaults to "Jake Crowley" from `AI_SETTINGS.DEFAULT_AUTHOR`

## Testing Checklist

- [ ] Generate article with AI
- [ ] Verify all required fields are populated
- [ ] Check field lengths don't exceed limits
- [ ] Confirm URL is unique
- [ ] Test "Save as Draft" (status='draft', date_published=null)
- [ ] Test "Publish Now" (status='published', date_published=now)
- [ ] Verify featured toggle works
- [ ] Check article appears in "All Articles" tab
- [ ] Confirm timestamps are set correctly
